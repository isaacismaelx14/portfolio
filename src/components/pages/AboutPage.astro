---
import Layout from "../../layouts/Layout.astro";
import Section from "../Section.astro";
import ResumeTemplate from "../ResumeTemplate.astro";
import { useTranslations } from "../../i18n/utils";

interface Props {
    lang: "en" | "es";
}

const { lang } = Astro.props;
const t = useTranslations(lang);

const experience = [
    {
        year: `Jun 2025 - ${t("about.present")}`,
        title: t("about.experienceList.wgsn.title"),
        company: `${t("about.experienceList.wgsn.company")} 路 ${t("about.fullTime")} 路 ${t("about.remote")}`,
        description: t("about.experienceList.wgsn.description"),
        skills: ["Software Architecture", "React", "AWS", "TypeScript"],
    },
    {
        year: `Oct 2023 - ${t("about.present")}`,
        title: t("about.experienceList.zitdevs.title"),
        company: `${t("about.experienceList.zitdevs.company")} 路 ${t("about.partTime")} 路 ${t("about.remote")}`,
        description: t("about.experienceList.zitdevs.description"),
        skills: ["Leadership", "Product Strategy", "Team Building"],
    },
    {
        year: "Apr 2024 - May 2025",
        title: t("about.experienceList.vpm.title"),
        company: `${t("about.experienceList.vpm.company")} 路 ${t("about.fullTime")} 路 ${t("about.remote")}`,
        description: t("about.experienceList.vpm.description"),
        skills: ["Vue.js", "Express.js", "MySQL", "GraphQL", "Full-Stack Development"],
    },
    {
        year: "Apr 2022 - Apr 2024",
        title: t("about.experienceList.minnek.title"),
        company: `${t("about.experienceList.minnek.company")} 路 ${t("about.fullTime")}`,
        description: t("about.experienceList.minnek.description"),
        isGrouped: true,
        positions: [
            {
                year: "Oct 2023 - Apr 2024",
                title: t("about.experienceList.minnek.positions.lead.title"),
                description: t("about.experienceList.minnek.positions.lead.description"),
            },
            {
                year: "Jul 2023 - Dec 2023",
                title: t("about.experienceList.minnek.positions.mid.title"),
                description: t("about.experienceList.minnek.positions.mid.description"),
            },
            {
                year: "Apr 2022 - Jul 2023",
                title: t("about.experienceList.minnek.positions.junior.title"),
                description: t("about.experienceList.minnek.positions.junior.description"),
            },
        ],
        skills: ["Next.js", "NestJS", "TypeScript", "Go", "BigCommerce", "Vue.js", "Team Leadership"],
    },
    {
        year: "Apr 2022 - Jul 2023",
        title: t("about.experienceList.ysw.title"),
        company: `${t("about.experienceList.ysw.company")} 路 ${t("about.fullTime")} 路 ${t("about.remote")}`,
        description: t("about.experienceList.ysw.description"),
        skills: ["HTML5", "JavaScript", "BigCommerce", "SASS", "SQL"],
    },
    {
        year: "Aug 2020 - Mar 2021",
        title: t("about.experienceList.selfEmployed.title"),
        company: t("about.experienceList.selfEmployed.company"),
        description: t("about.experienceList.selfEmployed.description"),
        skills: ["Front-End Development", "JavaScript", "HTML", "CSS"],
    },
];

const education = [
    {
        year: `2026 (${t("about.expected")})`,
        title: t("about.educationList.uapa.title"),
        company: t("about.educationList.uapa.company"),
        description: t("about.educationList.uapa.description"),
    },
    {
        year: "2022",
        title: t("about.educationList.platzi.title"),
        company: t("about.educationList.platzi.company"),
        description: "",
    },
    {
        year: "2021",
        title: t("about.educationList.itla.title"),
        company: t("about.educationList.itla.company"),
        description: "",
    },
    {
        year: "2020",
        title: t("about.educationList.politecnico.title"),
        company: t("about.educationList.politecnico.company"),
        description: "",
    },
    {
        year: "2016 - 2021",
        title: t("about.educationList.iui.title"),
        company: t("about.educationList.iui.company"),
        description: "",
    },
];

const skills = [
    { name: "Node.js", years: "+9y" },
    { name: "TypeScript", years: "+7y" },
    { name: "React", years: "+6y" },
    { name: "Next.js", years: "+5y" },
    { name: "AWS", years: "+4y" },
    { name: "Vue.js", years: "+3y" },
    { name: "NestJS", years: "" },
    { name: "Express.js", years: "" },
    { name: "GraphQL", years: "" },
    { name: "Go", years: "" },
    { name: "PostgreSQL", years: "" },
    { name: "MySQL", years: "" },
    { name: "MongoDB", years: "" },
    { name: "Docker", years: "" },
    { name: "BigCommerce", years: "" },
    { name: "Tailwind CSS", years: "" },
];

const languagesList = [
    { name: t("about.languagesList.spanish.name"), level: t("about.languagesList.spanish.level"), flag: "" },
    { name: t("about.languagesList.english.name"), level: t("about.languagesList.english.level"), flag: "吼" },
];

const pageDescription = lang === "es" 
    ? "Conoce a Isaac Martinez - Arquitecto de Software con m谩s de 9 a帽os de experiencia en Node.js, TypeScript, AWS e IA. Revisa mi experiencia, habilidades y educaci贸n."
    : "Meet Isaac Martinez - Software Architect with 9+ years of experience in Node.js, TypeScript, AWS, and AI. View my experience, skills, and education.";
---

<Layout 
    title={`${t("about.title")} | Isaac Martinez`}
    description={pageDescription}
    type="profile"
>
    <Section maxWidth="6xl" first>
        <!-- Header with Terminal Style -->
        <div class="mb-8 sm:mb-12">
            <div class="flex flex-wrap items-center justify-between gap-3 sm:gap-4">
                <div class="flex flex-wrap items-center gap-3 sm:gap-4">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 dark:text-white">
                        {t("about.title")}
                    </h1>
                    <div 
                        class="flex items-center gap-2 px-3 py-1.5 rounded-md bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300"
                        style="view-transition-name: run-btn;"
                    >
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span class="font-semibold text-xs">{t("about.badge")}</span>
                    </div>
                </div>
                <button
                    id="download-resume-btn"
                    class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-900 dark:bg-white text-white dark:text-gray-900 hover:bg-gray-800 dark:hover:bg-gray-100 transition-colors font-medium text-sm print:hidden"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span id="download-btn-text" data-loading={t("about.downloadingResume")}>{t("about.downloadResume")}</span>
                </button>
            </div>
        </div>

        <!-- Bio Terminal Window -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-8 sm:mb-12">
            <!-- Window Header -->
            <div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">about.md</div>
                <div class="w-12"></div>
            </div>
            
            <!-- Content -->
            <div class="p-6 sm:p-8">
                <blockquote class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-6 pl-4 border-l-4 border-blue-500">
                    "{t("about.quote")}"
                </blockquote>
                <div class="space-y-4 text-gray-600 dark:text-gray-400 leading-relaxed">
                    <p>{t("about.p1")}</p>
                    <p>{t("about.p2")}</p>
                    <p>{t("about.p3")}</p>
                </div>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid lg:grid-cols-2 gap-6 sm:gap-8 mb-8 sm:mb-12">
            <!-- Skills Terminal -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                <div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-400"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                        <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">skills.json</div>
                    <div class="w-12"></div>
                </div>
                <div class="p-4 sm:p-6">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <span class="text-green-500">$</span> {t("about.skills")}
                    </h2>
                    <div class="grid grid-cols-2 gap-2">
                        {skills.map((skill) => (
                            <div class="flex items-center justify-between p-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700 font-mono text-sm">
                                <span class="text-gray-800 dark:text-gray-200">{skill.name}</span>
                                {skill.years && (
                                    <span class="text-xs text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-1.5 py-0.5 rounded">
                                        {skill.years}
                                    </span>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            <!-- Languages Terminal -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden h-fit">
                <div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                    <div class="flex gap-2">
                        <div class="w-3 h-3 rounded-full bg-red-400"></div>
                        <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                        <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">languages.config</div>
                    <div class="w-12"></div>
                </div>
                <div class="p-4 sm:p-6">
                    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                        <span class="text-green-500">$</span> {t("about.languages")}
                    </h2>
                    <div class="space-y-3">
                        {languagesList.map((language) => (
                            <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-100 dark:border-gray-700">
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl">{language.flag}</span>
                                    <span class="font-semibold text-gray-900 dark:text-white">{language.name}</span>
                                </div>
                                <span class="text-sm text-gray-500 dark:text-gray-400 bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded font-mono">
                                    {language.level}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>

        <!-- Experience Timeline Terminal -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-8 sm:mb-12">
            <div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">experience.log</div>
                <div class="w-12"></div>
            </div>
            <div class="p-4 sm:p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="text-green-500">$</span> git log --oneline {t("about.experience").toLowerCase()}
                </h2>
                <div class="space-y-6">
                    {experience.map((item) => (
                        <div class="relative pl-6 pb-6 border-l-2 border-gray-200 dark:border-gray-700 last:border-transparent last:pb-0">
                            <div class="absolute left-0 top-0 w-3 h-3 -translate-x-[7px] rounded-full bg-blue-500 border-2 border-white dark:border-gray-800"></div>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 mb-2">
                                <span class="text-xs font-mono bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded w-fit whitespace-nowrap">
                                    {item.year}
                                </span>
                                <h3 class="font-bold text-gray-900 dark:text-white">{item.title}</h3>
                            </div>
                            <p class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-2">{item.company}</p>
                            
                            {/* Grouped positions (e.g., Minnek career progression) */}
                            {item.isGrouped && item.positions ? (
                                <div class="mt-3 space-y-3">
                                    {item.positions.map((pos, idx) => (
                                        <div class="relative pl-4 border-l-2 border-blue-200 dark:border-blue-800">
                                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 mb-1">
                                                <span class="text-[10px] font-mono text-gray-500 dark:text-gray-400 whitespace-nowrap">
                                                    {pos.year}
                                                </span>
                                                <span class="text-sm font-semibold text-gray-800 dark:text-gray-200">
                                                    {pos.title}
                                                </span>
                                            </div>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">{pos.description}</p>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                item.description && (
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">{item.description}</p>
                                )
                            )}
                            
                            {item.skills && item.skills.length > 0 && (
                                <div class="flex flex-wrap gap-1.5 mt-3">
                                    {item.skills.map((skill) => (
                                        <span class="text-xs px-2 py-0.5 rounded bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-medium">
                                            {skill}
                                        </span>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </div>

        <!-- Education Timeline Terminal -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="bg-gray-100 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">education.log</div>
                <div class="w-12"></div>
            </div>
            <div class="p-4 sm:p-6">
                <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                    <span class="text-green-500">$</span> git log --oneline {t("about.education").toLowerCase()}
                </h2>
                <div class="space-y-4">
                    {education.map((item) => (
                        <div class="relative pl-6 pb-4 border-l-2 border-gray-200 dark:border-gray-700 last:border-transparent last:pb-0">
                            <div class="absolute left-0 top-0 w-3 h-3 -translate-x-[7px] rounded-full bg-green-500 border-2 border-white dark:border-gray-800"></div>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3 mb-2">
                                <span class="text-xs font-mono bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 px-2 py-1 rounded w-fit">
                                    {item.year}
                                </span>
                                <h3 class="font-bold text-gray-900 dark:text-white">{item.title}</h3>
                            </div>
                            <p class="text-sm font-semibold text-green-600 dark:text-green-400">{item.company}</p>
                            {item.description && (
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{item.description}</p>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    </Section>

    <!-- Hidden Resume Template for PDF Generation -->
    <div id="resume-wrapper" class="fixed -left-[9999px] top-0 opacity-0 pointer-events-none" aria-hidden="true">
        <ResumeTemplate
            name="Isaac Martinez"
            title={lang === "es" ? "Arquitecto de Software" : "Software Architect"}
            email="me@isaacmartinez.dev"
            phone="+1 (829) 348-5948"
            location="Santiago, Dominican Republic"
            website="isaacmartinez.dev"
            linkedin="linkedin.com/in/isaacismaelx14"
            github="github.com/isaacismaelx14"
            summary={t("about.p1")}
            experience={experience}
            education={education}
            skills={skills}
            languages={languagesList}
            labels={{
                experience: t("about.experience"),
                education: t("about.education"),
                skills: t("about.skills"),
                languages: t("about.languages"),
                contact: lang === "es" ? "Contacto" : "Contact"
            }}
        />
    </div>
</Layout>

<style>
    #resume-wrapper {
        z-index: -9999;
    }
</style>

<script>
    // Lazy load PDF generation libraries only when needed
    async function generatePDF() {
        const [{ default: html2canvas }, { jsPDF }] = await Promise.all([
            import('html2canvas-pro'),
            import('jspdf')
        ]);

        const resumeElement = document.getElementById('resume-template');
        if (!resumeElement) {
            console.error('Resume template not found');
            return;
        }

        // Temporarily make visible for capture
        const wrapper = document.getElementById('resume-wrapper');
        if (wrapper) {
            wrapper.style.opacity = '1';
            wrapper.style.left = '0';
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.zIndex = '9999';
        }

        // Wait for render
        await new Promise(resolve => setTimeout(resolve, 100));

        try {
            // A4 dimensions at 96 DPI: 794 x 1123 px
            const canvas = await html2canvas(resumeElement, {
                scale: 2, // 2x for high quality
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                logging: false,
                windowWidth: 794,
                windowHeight: 1123,
            });

            // A4 in mm
            const a4Width = 210;
            const a4Height = 297;

            // Create PDF
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true
            });

            // Add image to PDF - fit to A4
            const imgData = canvas.toDataURL('image/jpeg', 0.92);
            pdf.addImage(imgData, 'JPEG', 0, 0, a4Width, a4Height, undefined, 'FAST');

            // Download
            pdf.save('Isaac_Martinez_Resume.pdf');
        } catch (error) {
            console.error('Error generating PDF:', error);
            // Fallback to print
            window.print();
        } finally {
            // Hide again
            if (wrapper) {
                wrapper.style.opacity = '0';
                wrapper.style.left = '-9999px';
                wrapper.style.position = 'fixed';
                wrapper.style.zIndex = '-9999';
            }
        }
    }

    function initDownloadButton() {
        const downloadBtn = document.getElementById('download-resume-btn');
        const btnText = document.getElementById('download-btn-text');

        if (!downloadBtn || !btnText) return;

        // Remove old listeners by cloning
        const newBtn = downloadBtn.cloneNode(true);
        downloadBtn.parentNode?.replaceChild(newBtn, downloadBtn);
        
        const newBtnText = newBtn.querySelector('#download-btn-text');
        const newBtnIcon = newBtn.querySelector('svg');

        newBtn.addEventListener('click', async () => {
            // Update UI to loading state
            const originalText = newBtnText?.textContent || '';
            if (newBtnText) {
                newBtnText.textContent = newBtnText.dataset.loading || 'Generating...';
            }
            newBtn.disabled = true;
            newBtn.classList.add('opacity-75', 'cursor-not-allowed');
            
            // Add spinner animation to icon
            if (newBtnIcon) {
                newBtnIcon.classList.add('animate-spin');
            }

            try {
                await generatePDF();
            } catch (error) {
                console.error('PDF generation failed:', error);
            } finally {
                // Reset UI
                if (newBtnText) {
                    newBtnText.textContent = originalText;
                }
                newBtn.disabled = false;
                newBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                if (newBtnIcon) {
                    newBtnIcon.classList.remove('animate-spin');
                }
            }
        });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initDownloadButton);
    document.addEventListener('astro:page-load', initDownloadButton);
</script>
