---
import { languages } from "../i18n/utils";
import { getLangFromUrl } from "../i18n/utils";
import ChevronDownIcon from "./icons/ChevronDownIcon.astro";
import CheckIcon from "./icons/CheckIcon.astro";

const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;

function getLocalizedPath(targetLang: string) {
    const hasLangPrefix = Object.keys(languages).some((l) =>
        currentPath.startsWith(`/${l}`),
    );

    // Remove existing language prefix if present
    let cleanPath = currentPath;
    if (hasLangPrefix) {
        const parts = currentPath.split("/");
        // parts[0] is empty, parts[1] is lang
        cleanPath = "/" + parts.slice(2).join("/");
    } else if (currentPath === "/") {
        cleanPath = "/";
    }

    // Ensure cleanPath starts with /
    if (!cleanPath.startsWith("/")) {
        cleanPath = "/" + cleanPath;
    }

    return `/${targetLang}${cleanPath === "/" ? "" : cleanPath}`;
}

const flags = {
    en: "ðŸ‡ºðŸ‡¸",
    es: "ðŸ‡©ðŸ‡´",
};

const currentLangLabel = languages[lang as keyof typeof languages];
const currentFlag = flags[lang as keyof typeof flags];
---

<div class="relative inline-block text-left" id="lang-menu-container">
    <button
        type="button"
        class="inline-flex items-center justify-center gap-2 w-full rounded-md border border-gray-300 dark:border-gray-700 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-blue-500 transition-colors"
        id="lang-menu-button"
        aria-expanded="false"
        aria-haspopup="true"
    >
        <span class="text-lg leading-none">{currentFlag}</span>
        <span class="hidden md:inline">{currentLangLabel}</span>
        <ChevronDownIcon class="-mr-1 ml-1 h-5 w-5" />
    </button>

    <div
        class="origin-top-right absolute right-0 mt-2 w-40 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none transform opacity-0 scale-95 transition-all duration-200 ease-out pointer-events-none"
        role="menu"
        aria-orientation="vertical"
        aria-labelledby="lang-menu-button"
        tabindex="-1"
        id="lang-menu-dropdown"
    >
        <div class="py-1" role="none">
            {
                Object.entries(languages).map(([label, name]) => (
                    <a
                        href={getLocalizedPath(label)}
                        class={`flex items-center gap-3 px-4 py-2 text-sm ${
                            lang === label
                                ? "bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white"
                                : "text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700/50"
                        }`}
                        role="menuitem"
                        tabindex="-1"
                        onclick={`localStorage.setItem('preferred-lang', '${label}')`}
                    >
                        <span class="text-lg leading-none">
                            {flags[label as keyof typeof flags]}
                        </span>
                        <span>{name}</span>
                        {lang === label && (
                            <CheckIcon class="ml-auto h-4 w-4 text-green-500" />
                        )}
                    </a>
                ))
            }
        </div>
    </div>
</div>

<script>
    const button = document.getElementById("lang-menu-button");
    const dropdown = document.getElementById("lang-menu-dropdown");
    const container = document.getElementById("lang-menu-container");

    if (button && dropdown && container) {
        let isOpen = false;

        const toggleMenu = () => {
            isOpen = !isOpen;
            button.setAttribute("aria-expanded", isOpen.toString());
            if (isOpen) {
                dropdown.classList.remove(
                    "opacity-0",
                    "scale-95",
                    "pointer-events-none",
                );
                dropdown.classList.add("opacity-100", "scale-100");
            } else {
                dropdown.classList.remove("opacity-100", "scale-100");
                dropdown.classList.add(
                    "opacity-0",
                    "scale-95",
                    "pointer-events-none",
                );
            }
        };

        button.addEventListener("click", (e) => {
            e.stopPropagation();
            toggleMenu();
        });

        document.addEventListener("click", (event) => {
            if (!container.contains(event.target as Node)) {
                if (isOpen) toggleMenu();
            }
        });

        // Close on escape key
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && isOpen) {
                toggleMenu();
            }
        });
    }
</script>
